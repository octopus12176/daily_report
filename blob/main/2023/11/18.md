## 2023/11/18（土）

## 取り組んだ課題

- タイピング練習
- 「達人に学ぶDB設計」を読む

## わかったこと

- 「達人に学ぶDB設計」を読む
  - 非正規化テーブルならば、SQLで結合を使わずに済む。
  - 正規化と検索SQLのパフォーマンスは強いトレードオフの関係にある。
  - サマリデータを冗長に保持すると正規形に違反するが、検索を高速化できる。
  - 非正規化には、更新不整合のリスク以外にも3つのリスクがある。
    - 非正規化は、検索のパフォーマンスは向上させるが更新のパフォーマンスを低下させる。
    - データのリアルタイム性（鮮度）を低下させる。
    - 後続の工程で設計変更すると、手戻りが大きい。
  - データベースのパフォーマンスはインデックスと統計情報が決める。
    - インデックス設計
      - インデックスがSQLのパフォーマンス改善のための非常にポピュラーな手段である理由
        - アプリケーションのコードに影響を与えない（アプリケーション透過的）。
        - テーブルのデータに影響を与えない（データ透過的）。
        - それでいて性能改善の効果が大きい。
      - Btreeインデックス
        - 最もポピュラーなインデックス
        - Btreeインデックスはオール4の秀才。
        - Btreeインデックスの構造
          - 均一性
          - 持続性
          - 処理汎用性
          - 非等値性
          - 親ソート性
        - Btreeインデックス作成の指針
          - 大規模なテーブルに対して作成する。
          - カーディナリティの高い列に作成する。
          - SQL文でWHERE句の選択条件、または結合条件に使用されている列に作成する
        - データ量が少ない場合はインデックスの効果はない。
        - Btreeインデックスとカーディナリティ
          - カーディナリティが高い列ほどインデックスの効果が高い。ただし、値が平均的に分散しているのがベスト。
    - 統計情報
      - オプティマイザと実行計画
        - ユーザーから何らかの形でSQL文がDBMSへ発行される。パーサがSQL文が適法な構文であるかチェックする。
        - パーサによるチェックが済むと次にSQLは「オプティマイザ」というモジュールへ送られる。
        - オプティマイザは「カタログマネージャ」というモジュールに、統計情報の照会かける。
        - カタログマネージャから統計情報を受け取ると、オプティマイザはたくさんの経路の中から最短経路を選択し、SQLを手続きに変換する。（実行計画を作成）
        - 実テーブルであるテーブルへとアクセスを行う。
      - 統計情報の設計指針
        - 統計情報収集のタイミング
          - データが大きく更新された後、なるべく早く行う。
          - 統計情報収集は原則、夜間帯に実施する。
        - 統計情報収集の対象（範囲）
          - 一時テーブルの収集に関しては注意する。
      - 統計情報の凍結
        - 現状のものから実行計画を変化させたくない場合は統計情報を凍結する。
        - 統計情報の凍結は、オプティマイザを信じない悲観的設計。しかし現実に実施するのはかなり大変。
  - 論理設計のバッドノウハウ
    - 非スカラ値（第１正規形未満）
    - ダブルミーニング
    - 単一参照テーブル
    - テーブル分割
    - 不適切なキー
    - ダブルマスタ
  - 論理設計のグレーノウハウ
    - 代理キー
    - 列待ちテーブル
    - アドホックな集計キー
    - 多段ビュー
  - SQLで木構造を扱う
    - 隣接リストモデル
      - 最も古典的なモデル。検索/更新とともに複雑な処理を必要とする。DBMS依存の昨日を使うことでこの欠点を軽減できるが、あくまで独自機能に頼ることになるため、汎用性がない。
    - 入れ子集合モデル
      - 木を円の包含関係によって表現するモデル。検索のSQLが簡単になるが、更新処理のパフォーマンスに問題を抱えている。
    - 入れ子区間モデル
      - 入れ子集合モデルの拡張版。入れ子集合モデルの欠点だった更新処理のパフォーマンス問題を克服できる。ただし、実数型の有効桁数が十分に確保されていなければ実用できでない。
    - 経路列挙モデル
      - ルートから各ノードまでの経路を保持するモデル。検索に強く更新に弱いのが特徴。

## 感じたこと 
- 「達人に学ぶDB設計」を読む
  - テーブル設計にしろ、コーディングにしろアンチパターンと呼ばれるものは知識がないと避けようがないことだと思うので、積極的に知識を吸収していくことが大切だと感じた。

## 次やること

- 「達人に学ぶDB設計」のブログ作成

## 勉強時間

- Today: 3.5h
- Total: 557.5h
